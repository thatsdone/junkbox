<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>  [ja] How to manage GRUB default kernel | That's Done!
</title>
  <link rel="canonical" href="https://thatsdone.github.io/junkbox/manage_grub_default.html">


  <link rel="stylesheet" href="https://thatsdone.github.io/junkbox/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://thatsdone.github.io/junkbox/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://thatsdone.github.io/junkbox/theme/css/pygments/default.min.css">
  <link rel="stylesheet" href="https://thatsdone.github.io/junkbox/theme/css/theme.css">

  <link rel="alternate" type="application/atom+xml" title="Full Atom Feed"
        href="https://thatsdone.github.io/junkbox/feeds/all.atom.xml">
  <link rel="alternate" type="application/atom+xml" title="Categories Atom Feed"
        href="https://thatsdone.github.io/junkbox/feeds/{slug}.atom.xml">  
  <meta name="description" content="GRUBのbootに使われるkernelを管理する">


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
  <div class="col-sm-12">
    <h1 class="title"><a href="https://thatsdone.github.io/junkbox/">That's Done!</a></h1>
      <p class="text-muted">thatsdone's (mostly technical) memorandum</p>
      <ul class="list-inline">
          <li class="list-inline-item"><a href="about.html" target="_blank">about</a></li>
          <li class="list-inline-item"><a href="https://github.com/thatsdone" target="_blank">github</a></li>
          <li class="list-inline-item"><a href="https://qiita.com/thatsdone" target="_blank">qiita</a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  [ja] How to manage GRUB default kernel
</h1>
      <hr>
  <article class="article">
    <header>
      <ul class="list-inline">
        <li class="list-inline-item text-muted" title="2024-10-14T16:52:00+09:00">
          <i class="fa fa-clock-o"></i>
          Mon 14 October 2024
        </li>
        <li class="list-inline-item">
          <i class="fa fa-folder-open-o"></i>
          <a href="https://thatsdone.github.io/junkbox/category/tech.html">tech</a>
        </li>
          <li class="list-inline-item">
            <i class="fa fa-user-o"></i>
              <a href="https://thatsdone.github.io/junkbox/author/thatsdone.html">thatsdone</a>          </li>
      </ul>
    </header>
    <div class="content">
      <p>最近、かなり久しぶりにvanilla kernelをビルドする機会があり、
kernelを切り替えて使いたい場合のGRUBの設定で気づいたことがあったのでメモ。</p>
<p>最近...といっても、20.04くらいからだろうか。submenu というものが導入され、昔のノウハウが効かなくなっている模様。</p>
<p>2024/10/14時点での情報。</p>
<h2>Ubuntu 24.04 LTS時点での答</h2>
<p>以下の手順でdefaultでbootに使われるkernelを切り替え可能。</p>
<ol>
<li>/etc/default/grub の GRUB_DEFAULT に saved を設定する<ul>
<li><code>GRUB_DEFAULT=0</code> → <code>GRUB_DEFAULT=saved</code></li>
<li>Ubuntuだと普通は0になっているので、ここの修正が必要ということ</li>
<li>なお、記事によっては、/etc/default/grub に <code>GRUB_SAVEDEFAULT=true</code> を設定するべしという説明がある。これを入れると、私の場合は、後述の grub-reboot コマンドによる一時的な切り替えが効かなくなった。</li>
</ul>
</li>
<li>grub-set-default で、'SUBMENU_ID&gt;MENUENTRY_ID' の形式で指定する<ul>
<li>SUBMENU_ID は <code>sudo grep submenu /boot/grub/grub.cfg</code> で調べる</li>
<li>MENUENTRY_ID は <code>sudo grep menuentry /boot/grub/grub.cfg</code> で調べる</li>
<li>例: <code># sudo grub-set-default 'gnulinux-advanced-69cecedb-4058-4b83-8507-cca6498f4099&gt;gnulinux-6.8.0-45-generic-advanced-69cecedb-4058-4b83-8507-cca6498f4099'</code></li>
</ul>
</li>
<li><code># update-grub</code> する</li>
<li><code># reboot</code> する</li>
</ol>
<p>これで指定したkernelがdefaultに切り替わる。</p>
<h2>一時的に次にbootするkernelを切り替える場合</h2>
<p>kernelそのものをいじっている場合など、次のboot時のみ一時的に切り替えたい等の場合は、<code>grub-reboot</code> コマンドが使える。</p>
<ol>
<li>/etc/default/grub の GRUB_DEFAULT が saved になっていることを確認する</li>
<li><code># grub-reboot 'SUBMENU_ID&gt;MENUENTRY_ID'</code></li>
<li><code># update-grub</code> する</li>
<li><code># reboot</code> する</li>
</ol>
<p>もう一度rebootすると、元のdefault kernelで起動される。</p>
<h2>サンプル /boot/grub/grub.cfg</h2>
<p>以下は私の、Ubuntu 22.04 から 24.04へ do-release-upgrade した環境の /boot/grub/grub.cfg の例。</p>
<p>162行目の <code>$menuentry_id_option</code> の後ろの <code>gnulinux-advanced-32227d3a-e56d-453c-b030-d3c44576fa3f'</code> が上記のSUBMENU_IDの例。</p>
<p>この環境では、そのままだと 163行目の 'Ubuntu, with Linux 6.8.0-45-generic' が使われるのだが、
190行目の <code>'gnulinux-5.15.0-122-generic-advanced-32227d3a-e56d-453c-b030-d3c44576fa3f'</code> を使って
 <code># grub-set-default 'SUBMENU_ID&gt;MENUENTRY_ID'</code> すればよい。</p>
<p>ポイントは、私の場合は以下の2点だった。</p>
<ol>
<li>SUBMENU_ID と MENUENTRY_IDの間は <code>&gt;</code> でスペースを空けずにつなぐ</li>
<li><code>'</code> でquoteするのが安全</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="mi">162</span><span class="w"> </span><span class="n">submenu</span><span class="w"> </span><span class="s1">&#39;Advanced options for Ubuntu&#39;</span><span class="w"> </span><span class="o">$</span><span class="n">menuentry_id_option</span><span class="w"> </span><span class="s1">&#39;gnulinux-advanced-32227d3a-e56d-453c-b030-d3c44576fa3f&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="mi">163</span><span class="w">         </span><span class="n">menuentry</span><span class="w"> </span><span class="s1">&#39;Ubuntu, with Linux 6.8.0-45-generic&#39;</span><span class="w"> </span><span class="o">--</span><span class="k">class</span><span class="w"> </span><span class="n">ubuntu</span><span class="w"> </span><span class="o">--</span><span class="k">class</span><span class="w"> </span><span class="n">gnu</span><span class="o">-</span><span class="n">linux</span><span class="w"> </span><span class="o">--</span><span class="k">class</span><span class="w"> </span><span class="n">gnu</span><span class="w"> </span><span class="o">--</span><span class="k">class</span><span class="w"> </span><span class="n">os</span><span class="w"> </span><span class="o">$</span><span class="n">menuentry_id_option</span><span class="w"> </span><span class="s1">&#39;gnulinux-6.8.0-45-    generic-advanced-32227d3a-e56d-453c-b030-d3c44576fa3f&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="mi">164</span><span class="w">                 </span><span class="n">recordfail</span>
<span class="mi">165</span><span class="w">                 </span><span class="n">load_video</span>
<span class="mi">166</span><span class="w">                 </span><span class="n">gfxmode</span><span class="w"> </span><span class="o">$</span><span class="n">linux_gfx_mode</span>
<span class="mi">167</span><span class="w">                 </span><span class="n">insmod</span><span class="w"> </span><span class="n">gzio</span>
<span class="mi">168</span><span class="w">                 </span><span class="k">if</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">grub_platform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xxen</span><span class="w"> </span><span class="p">];</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">insmod</span><span class="w"> </span><span class="n">xzio</span><span class="p">;</span><span class="w"> </span><span class="n">insmod</span><span class="w"> </span><span class="n">lzop</span><span class="w">    </span><span class="n">io</span><span class="p">;</span><span class="w"> </span><span class="n">fi</span>
<span class="mi">169</span><span class="w">                 </span><span class="n">insmod</span><span class="w"> </span><span class="n">part_msdos</span>
<span class="mi">170</span><span class="w">                 </span><span class="n">insmod</span><span class="w"> </span><span class="n">ext2</span>
<span class="mi">171</span><span class="w">                 </span><span class="n">search</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">floppy</span><span class="w"> </span><span class="o">--</span><span class="n">fs</span><span class="o">-</span><span class="n">uuid</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="o">=</span><span class="n">root</span><span class="w"> </span><span class="mi">32227</span><span class="n">d3a</span><span class="o">-</span><span class="n">e56d</span><span class="o">-</span><span class="mi">453</span><span class="n">c</span><span class="o">-</span><span class="n">b</span><span class="w">    </span><span class="mi">030</span><span class="o">-</span><span class="n">d3c44576fa3f</span>
<span class="mi">172</span><span class="w">                 </span><span class="n">echo</span><span class="w">    </span><span class="s1">&#39;Loading Linux 6.8.0-45-generic ...&#39;</span>
<span class="mi">173</span><span class="w">                 </span><span class="n">linux</span><span class="w">   </span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">vmlinuz</span><span class="o">-</span><span class="mf">6.8</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">45</span><span class="o">-</span><span class="n">generic</span><span class="w"> </span><span class="n">root</span><span class="o">=</span><span class="n">UUID</span><span class="o">=</span><span class="mi">32227</span><span class="n">d3a</span><span class="o">-</span><span class="n">e5</span><span class="w">    </span><span class="mi">6</span><span class="n">d</span><span class="o">-</span><span class="mi">453</span><span class="n">c</span><span class="o">-</span><span class="n">b030</span><span class="o">-</span><span class="n">d3c44576fa3f</span><span class="w"> </span><span class="n">ro</span>
<span class="mi">174</span><span class="w">                 </span><span class="n">echo</span><span class="w">    </span><span class="s1">&#39;Loading initial ramdisk ...&#39;</span>
<span class="mi">175</span><span class="w">                 </span><span class="n">initrd</span><span class="w">  </span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">initrd</span><span class="o">.</span><span class="n">img</span><span class="o">-</span><span class="mf">6.8</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">45</span><span class="o">-</span><span class="n">generic</span>
<span class="mi">176</span><span class="w">         </span><span class="p">}</span>

<span class="p">(</span><span class="n">snip</span><span class="p">)</span>

<span class="mi">190</span><span class="w">         </span><span class="n">menuentry</span><span class="w"> </span><span class="s1">&#39;Ubuntu, with Linux 5.15.0-122-generic&#39;</span><span class="w"> </span><span class="o">--</span><span class="k">class</span><span class="w"> </span><span class="n">ubuntu</span><span class="w"> </span><span class="o">--</span><span class="n">c</span><span class="w">    </span><span class="n">lass</span><span class="w"> </span><span class="n">gnu</span><span class="o">-</span><span class="n">linux</span><span class="w"> </span><span class="o">--</span><span class="k">class</span><span class="w"> </span><span class="n">gnu</span><span class="w"> </span><span class="o">--</span><span class="k">class</span><span class="w"> </span><span class="n">os</span><span class="w"> </span><span class="o">$</span><span class="n">menuentry_id_option</span><span class="w"> </span><span class="s1">&#39;gnulinux-5.15.0-    122-generic-advanced-32227d3a-e56d-453c-b030-d3c44576fa3f&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="mi">191</span><span class="w">                 </span><span class="n">recordfail</span>
<span class="mi">192</span><span class="w">                 </span><span class="n">load_video</span>
<span class="mi">193</span><span class="w">                 </span><span class="n">gfxmode</span><span class="w"> </span><span class="o">$</span><span class="n">linux_gfx_mode</span>
<span class="mi">194</span><span class="w">                 </span><span class="n">insmod</span><span class="w"> </span><span class="n">gzio</span>
<span class="mi">195</span><span class="w">                 </span><span class="k">if</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">grub_platform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xxen</span><span class="w"> </span><span class="p">];</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">insmod</span><span class="w"> </span><span class="n">xzio</span><span class="p">;</span><span class="w"> </span><span class="n">insmod</span><span class="w"> </span><span class="n">lzop</span><span class="w">    </span><span class="n">io</span><span class="p">;</span><span class="w"> </span><span class="n">fi</span>
<span class="mi">196</span><span class="w">                 </span><span class="n">insmod</span><span class="w"> </span><span class="n">part_msdos</span>
<span class="mi">197</span><span class="w">                 </span><span class="n">insmod</span><span class="w"> </span><span class="n">ext2</span>
<span class="mi">198</span><span class="w">                 </span><span class="n">search</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">floppy</span><span class="w"> </span><span class="o">--</span><span class="n">fs</span><span class="o">-</span><span class="n">uuid</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="o">=</span><span class="n">root</span><span class="w"> </span><span class="mi">32227</span><span class="n">d3a</span><span class="o">-</span><span class="n">e56d</span><span class="o">-</span><span class="mi">453</span><span class="n">c</span><span class="o">-</span><span class="n">b</span><span class="w">    </span><span class="mi">030</span><span class="o">-</span><span class="n">d3c44576fa3f</span>
<span class="mi">199</span><span class="w">                 </span><span class="n">echo</span><span class="w">    </span><span class="s1">&#39;Loading Linux 5.15.0-122-generic ...&#39;</span>
<span class="mi">200</span><span class="w">                 </span><span class="n">linux</span><span class="w">   </span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">vmlinuz</span><span class="o">-</span><span class="mf">5.15</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">122</span><span class="o">-</span><span class="n">generic</span><span class="w"> </span><span class="n">root</span><span class="o">=</span><span class="n">UUID</span><span class="o">=</span><span class="mi">32227</span><span class="n">d3a</span><span class="o">-</span><span class="w">    </span><span class="n">e56d</span><span class="o">-</span><span class="mi">453</span><span class="n">c</span><span class="o">-</span><span class="n">b030</span><span class="o">-</span><span class="n">d3c44576fa3f</span><span class="w"> </span><span class="n">ro</span>
<span class="mi">201</span><span class="w">                 </span><span class="n">echo</span><span class="w">    </span><span class="s1">&#39;Loading initial ramdisk ...&#39;</span>
<span class="mi">202</span><span class="w">                 </span><span class="n">initrd</span><span class="w">  </span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">initrd</span><span class="o">.</span><span class="n">img</span><span class="o">-</span><span class="mf">5.15</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">122</span><span class="o">-</span><span class="n">generic</span>
<span class="mi">203</span><span class="w">         </span><span class="p">}</span>
</code></pre></div>

<h2>References</h2>
<ul>
<li>Grubで前に起動したシステムを記憶する<ul>
<li>https://www.terakin.com/ja/blog/archives/129</li>
<li>/etc/default/grub に GRUB_SAVEDEFAULT=true が必要という説明がある。Windowsとのdual boot環境で、Linuxが普段使いだがWindows Updateでrebootを繰り返す...といった場合はこの記事に従うのがよいようだ。</li>
</ul>
</li>
<li>How to get grub2 to remember last choice?<ul>
<li>https://askubuntu.com/questions/148662/how-to-get-grub2-to-remember-last-choice</li>
</ul>
</li>
<li>Setting the desired kernel in GRUB menu<ul>
<li>https://askubuntu.com/questions/1526087/setting-the-desired-kernel-in-grub-menu</li>
<li>/etc/grub.d/40_custom/ にファイルを作るやりかた</li>
<li>Windows等とdual以上のboot環境にしたい場合に使うみたいだ</li>
</ul>
</li>
<li>How do you change and set the default Kernel in Ubuntu Machine?<ul>
<li>https://mnzel.medium.com/how-do-you-change-and-set-the-default-kernel-in-ubuntu-machine-7ad1107e1b6f</li>
<li>自分としてはコレがアタリだった</li>
</ul>
</li>
</ul>
    </div>
  </article>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
      <li class="list-inline-item"><a href="https://thatsdone.github.io/junkbox/authors.html">Authors</a></li>
    <li class="list-inline-item"><a href="https://thatsdone.github.io/junkbox/archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="https://thatsdone.github.io/junkbox/categories.html">Categories</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
  </p>
</div>    </div>
  </footer>
</body>

</html>