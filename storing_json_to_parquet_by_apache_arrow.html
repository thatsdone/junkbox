<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>  [ja] JSONをParquestに保存するのにApache Arrowを使ってみる | That's Done!
</title>
  <link rel="canonical" href="https://thatsdone.github.io/junkbox/storing_json_to_parquet_by_apache_arrow.html">


  <link rel="stylesheet" href="https://thatsdone.github.io/junkbox/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://thatsdone.github.io/junkbox/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://thatsdone.github.io/junkbox/theme/css/pygments/default.min.css">
  <link rel="stylesheet" href="https://thatsdone.github.io/junkbox/theme/css/theme.css">

  <link rel="alternate" type="application/atom+xml" title="Full Atom Feed"
        href="https://thatsdone.github.io/junkbox/feeds/all.atom.xml">
  <link rel="alternate" type="application/atom+xml" title="Categories Atom Feed"
        href="https://thatsdone.github.io/junkbox/feeds/{slug}.atom.xml">  
  <meta name="description" content="Apache Arrowを使ってJSONをParquestに保存してみる(Python)">


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
  <div class="col-sm-12">
    <h1 class="title"><a href="https://thatsdone.github.io/junkbox/">That's Done!</a></h1>
      <p class="text-muted">thatsdone's (mostly technical) memorandum</p>
      <ul class="list-inline">
          <li class="list-inline-item"><a href="about.html" target="_blank">about</a></li>
          <li class="list-inline-item"><a href="https://github.com/thatsdone" target="_blank">github</a></li>
          <li class="list-inline-item"><a href="https://qiita.com/thatsdone" target="_blank">qiita</a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  [ja] JSONをParquestに保存するのにApache Arrowを使ってみる
</h1>
      <hr>
  <article class="article">
    <header>
      <ul class="list-inline">
        <li class="list-inline-item text-muted" title="2020-02-15T21:00:00+09:00">
          <i class="fa fa-clock-o"></i>
          Sat 15 February 2020
        </li>
        <li class="list-inline-item">
          <i class="fa fa-folder-open-o"></i>
          <a href="https://thatsdone.github.io/junkbox/category/tech.html">tech</a>
        </li>
          <li class="list-inline-item">
            <i class="fa fa-user-o"></i>
              <a href="https://thatsdone.github.io/junkbox/author/thatsdone.html">thatsdone</a>          </li>
      </ul>
    </header>
    <div class="content">
      <p>事情で表記のようなことを考える必要があり、Parquetをちょっと調べています。</p>
<p>とりあえず、使いたい言語がPythonだったこと、Pandas等とも連携できることを考えて、Apache ArrowのPython bindingを使ってみることにしました。</p>
<h2>参考情報</h2>
<ul>
<li><a href="https://parquet.apache.org/documentation/latest/">Apache Parquet 公式サイトのHigh Level Document</a><ul>
<li>物理pフォーマット(の概要)の解説も出ています。</li>
</ul>
</li>
<li><a href="https://arrow.apache.org/docs/index.html">Apache Arrow ドキュメント</a></li>
<li><a href="https://dev.classmethod.jp/business/bigdata/20190614-apache-arrow-parquet/">Apache Arrow(PyArrow)を使って簡単かつ高速にParquetファイルに変換する</a><ul>
<li>Athena の CTAS (Create Table AS)では、デフォルトではParquetで保存されるらしい。</li>
</ul>
</li>
<li><a href="https://blog.amedama.jp/entry/2017/10/10/135331">Python: Apache Parquet フォーマットを扱ってみる</a></li>
<li><a href="https://medium.com/@rajnishtiwari2010/conversion-of-json-to-parquet-format-using-apache-parquet-in-java-b694a0a7487d">Conversion of JSON to parquet format using Apache Parquet in JAVA</a><ul>
<li>Javaの場合</li>
</ul>
</li>
</ul>
<h2>インストール</h2>
<p>大人の事情でCentOS7系で動作確認したかったので、Pythonは(未だに)2.7系を使っています(苦笑)</p>
<p>Apache Arrow自体は新しいものを使いたかったので、virtualenv を使って以下のようにお手軽に作成しました。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>virtualenv<span class="w"> </span>venvs/arrow
$<span class="w"> </span><span class="nb">source</span><span class="w"> </span>venvs/arrow/bin/activate
$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pyarrow
</code></pre></div>

<h2>とりあえずやってみたこと</h2>
<p>以下のようなテストデータを作って</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;key1&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;key2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value2-1&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="nt">&quot;key3&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;value3-1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;value3-1&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p>以下のようなプログラムで試しました。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pyarrow.parquet</span> <span class="k">as</span> <span class="nn">pq</span>
<span class="kn">from</span> <span class="nn">pyarrow</span> <span class="kn">import</span> <span class="n">json</span> <span class="k">as</span> <span class="n">pajson</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">pajson</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;test.json&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==================write table&#39;</span><span class="p">)</span>
<span class="n">pq</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">&#39;test.parquet&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==================using parquet.read_schema&#39;</span><span class="p">)</span>
<span class="n">schema</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">read_schema</span><span class="p">(</span><span class="s1">&#39;test.parquet&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
</code></pre></div>

<p>実行するとこんな感じになります。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>test.py
<span class="o">==================</span>write<span class="w"> </span><span class="nv">table</span>
<span class="o">==================</span>using<span class="w"> </span>parquet.read_schema
key1:<span class="w"> </span>int64
key2:<span class="w"> </span>string
key3:<span class="w"> </span>list&lt;item:<span class="w"> </span>string&gt;
<span class="w">  </span>child<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>item:<span class="w"> </span>string
metadata
--------
OrderedDict<span class="o">([(</span><span class="s1">&#39;ARROW:schema&#39;</span>,<span class="w"> </span><span class="s1">&#39;/////wgBAAAQAAAAAAAKAAwABgAFAAgACgAAAAABAwAMAAAACAAIAAAABAAIAAAABAAAAAMAAACcAAAAXAAAAAQAAACA////AAABDEAAAAAQAAAABAAAAAEAAAAIAAAAsP///6D///8AAAEFFAAAAAwAAAAEAAAAAAAAAMz///8EAAAAaXRlbQAAAAAEAAAAa2V5MwAAAADU////AAABBRgAAAAQAAAABAAAAAAAAAAEAAQABAAAAAQAAABrZXkyAAAAABAAFAAIAAYABwAMAAAAEAAQAAAAAAABAiQAAAAUAAAABAAAAAAAAAAIAAwACAAHAAgAAAAAAAABQAAAAAQAAABrZXkxAAAAAAAAAAA=&#39;</span><span class="o">)])</span>
</code></pre></div>

<p>後述の通り、先にスキーマを作らなくても動くのかどうか確認したかったのですが、入力に従ったスキーマが作成されているようです。</p>
<p>余談ですが、1レコードしかないので、サイズはこんな感じになりますね(苦笑)</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>du<span class="w"> </span>-b<span class="w"> </span>test.json<span class="w"> </span>test.parquet
<span class="m">80</span><span class="w">      </span>test.json
<span class="m">232</span><span class="w"> </span>test.parquet
</code></pre></div>

<h2>TODO</h2>
<ul>
<li>圧縮を試す</li>
<li>複数レコード格納する<ul>
<li>後述のトップレベル名無し配列の件も調べる</li>
</ul>
</li>
<li>事前にスキーマを定義した場合と動的に作成させた場合の違いの確認</li>
<li>スキーマにないelementが現れた場合の挙動の確認</li>
</ul>
<h2>TIPS(というか気づいたことのメモ)</h2>
<h3>スキーマは事前に準備しなくても動く</h3>
<p>確かに動くのですが、これで最適なのか、確認要。(TBD)</p>
<h3>pyarrow.json では Objectのネストはできない</h3>
<p>以下の例では "key4"の値はさらにObject(Pythonではdcit)になっていますが、これは<code>pyarrow.json.read_json()</code>に食わせるとエラーになるようです。</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;key1&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;key2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value2-1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;key3&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;value3-1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;value3-1&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;key4&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;key41&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;key42&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value42&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3>JSONで許されているトップレベルの名無しArrayは通らない</h3>
<p>JSONの規格上、以下のようなデータは許されているのですが、</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;key1&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;key2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value2-1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;key3&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;value3-1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;value3-1&quot;</span>
<span class="w">      </span><span class="p">]</span><span class="w"> </span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;key1&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;key2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value2-2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;key3&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;value3-2&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;value3-2&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<p>しかし、こんな感じでエラーになります。
これは、Arrayの要素を1つに減らしても同じです。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>test.py
Traceback<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>last<span class="o">)</span>:
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;test.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">6</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
<span class="w">    </span><span class="nv">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>pajson.read_json<span class="o">(</span><span class="s1">&#39;test3.json&#39;</span><span class="o">)</span>
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;pyarrow/_json.pyx&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">193</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>pyarrow._json.read_json
<span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;pyarrow/error.pxi&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">84</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>pyarrow.lib.check_status
pyarrow.lib.ArrowInvalid:<span class="w"> </span>JSON<span class="w"> </span>parse<span class="w"> </span>error:<span class="w"> </span>Column<span class="o">()</span><span class="w"> </span>changed<span class="w"> </span>from<span class="w"> </span>object<span class="w"> </span>to<span class="w"> </span>array<span class="w"> </span><span class="k">in</span><span class="w"> </span>row<span class="w"> </span><span class="m">0</span>
</code></pre></div>

<p>続きます。</p>
    </div>
  </article>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
      <li class="list-inline-item"><a href="https://thatsdone.github.io/junkbox/authors.html">Authors</a></li>
    <li class="list-inline-item"><a href="https://thatsdone.github.io/junkbox/archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="https://thatsdone.github.io/junkbox/categories.html">Categories</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
  </p>
</div>    </div>
  </footer>
</body>

</html>