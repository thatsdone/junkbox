<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>  [ja] libvirt notes | That's Done!
</title>
  <link rel="canonical" href="https://thatsdone.github.io/junkbox/libvirt_notes.html">


  <link rel="stylesheet" href="https://thatsdone.github.io/junkbox/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://thatsdone.github.io/junkbox/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://thatsdone.github.io/junkbox/theme/css/pygments/default.min.css">
  <link rel="stylesheet" href="https://thatsdone.github.io/junkbox/theme/css/theme.css">

  <link rel="alternate" type="application/atom+xml" title="Full Atom Feed"
        href="https://thatsdone.github.io/junkbox/feeds/all.atom.xml">
  <link rel="alternate" type="application/atom+xml" title="Categories Atom Feed"
        href="https://thatsdone.github.io/junkbox/feeds/{slug}.atom.xml">  
  <meta name="description" content="libvirt関連(特にvirt-install)のメモ">


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
  <div class="col-sm-12">
    <h1 class="title"><a href="https://thatsdone.github.io/junkbox/">That's Done!</a></h1>
      <p class="text-muted">thatsdone's (mostly technical) memorandum</p>
      <ul class="list-inline">
          <li class="list-inline-item"><a href="about.html" target="_blank">about</a></li>
          <li class="list-inline-item"><a href="https://github.com/thatsdone" target="_blank">github</a></li>
          <li class="list-inline-item"><a href="https://qiita.com/thatsdone" target="_blank">qiita</a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  [ja] libvirt notes
</h1>
      <hr>
  <article class="article">
    <header>
      <ul class="list-inline">
        <li class="list-inline-item text-muted" title="2026-01-03T13:00:00+09:00">
          <i class="fa fa-clock-o"></i>
          Sat 03 January 2026
        </li>
        <li class="list-inline-item">
          <i class="fa fa-folder-open-o"></i>
          <a href="https://thatsdone.github.io/junkbox/category/tech.html">tech</a>
        </li>
          <li class="list-inline-item">
            <i class="fa fa-user-o"></i>
              <a href="https://thatsdone.github.io/junkbox/author/thatsdone.html">thatsdone</a>          </li>
      </ul>
    </header>
    <div class="content">
      <p><a href="https://thatsdone.github.io/junkbox/generic_qemu_notes.html">Generic qemu qemu notes</a>でvirtio-canの話を書きましたが、qemu-system-ARCHを直叩きするのではなく、libvirtを使い、かつあまり一般的ではないdeviceを使いたいという話です。</p>
<p>/usr/bin 以下のシステム標準品を入れ替えてしまってもよいのですが、切り替えて使えるようにしたい場合、
libvirtでVM(というかlibvirt用語ではdomain)を定義するにはどうするか？</p>
<h2>2通りのやりかた</h2>
<p>ざっくり、以下の2通りのやりかたがあります。</p>
<ol>
<li>標準品libvirtでdomain定義した後、virsh edit や virt-xml で書き換える</li>
<li>virt-installのオプションでがんばる</li>
</ol>
<p>1.はちょっとうざいので2.の方法を模索していましたが、なんとか最低限やりたいことはできました。</p>
<h2>emulatorの変更</h2>
<p>上記の記事に書いたように、qemuのmainlineにマージされていないデバイスを使いたいことがあります。
この場合、システム標準の qemu-system-aarch64 や qemu-system-x86_64 とは違うバイナリを使うことになります。</p>
<p>AIサーチだと、virt-install に <code>--emulator</code> というオプションがあるよと出てきたのですが、
手元の virt-install だと使えなかったので(or ハルシネーション？)、もう少し調べたところ virt-install の
<code>--boot</code> オプションに <code>emulator=XXXX</code> と書けることがわかり、フルパスで指定しました。</p>
<p>なお、libvirtdのサーチパスを変更する…といった手法でもイケるようです。</p>
<h2>標準的ではないdeviceを使う</h2>
<p>qemuレベルだと、CAN device自体については<a href="https://www.qemu.org/docs/master/system/devices/can.html">公式にマニュアル</a>があるように、qemu側の仮想deviceについては <code>-object</code> で定義した上で、対応するqemu側のdriverを指定すればよいです。</p>
<p>qemu mainlineに入っている KVASER というCANのデバイスを、ホスト側のcan0に接続するには、qemu-system0-XXXに以下のように指定すればよいことがわかります。</p>
<div class="highlight"><pre><span></span><code>-object can-bus,id=canbus0
-device kvaser_pci,canbus=canbus0
-object can-host-socketcan,id=canhost0,if=can0,canbus=canbus0
</code></pre></div>

<p>これをlibvirtのdomain定義するのは現状無理な模様です。</p>
<p>ではどうするか？なのですが、domain定義時に qemu-system-XXX の command line を指定することができるので、
これを使いました。</p>
<p>virt-install の場合は <code>--qemu-commandline</code> というパラメータに渡します。</p>
<h2>PCI IDが衝突することがある</h2>
<p>当初、<code>virt-install</code> に以下のようなオプションを付けて試行したのですが、virt-instaellはPCI bridgeをたくさん接続してくれるので、これらとぶつかってしまいました。</p>
<div class="highlight"><pre><span></span><code><span class="o">--</span><span class="nv">qemu</span><span class="o">-</span><span class="nv">commandline</span><span class="o">=</span><span class="s2">&quot;-object can-bus,id=canbus2 -device virtio-can-pci,canbus=canbus2 -object can-host-socketcan,id=canhost2,if=vcan2,canbus=canbus2&quot;</span>
</code></pre></div>

<p>じゃあどうするか？なのですが、<code>virtio-can-pci</code> の場合は <code>addr</code> というパラメータがあり、PCIの function IDを指定できることがわかり、lspciの結果とてらしあわせて空きIDを指定することで回避できました。</p>
<p>私の環境の場合はBus 0の 06 まで埋まっていたので、07.0を使いました。以下の通りです。</p>
<div class="highlight"><pre><span></span><code><span class="o">--</span><span class="nx">qemu</span><span class="o">-</span><span class="nx">commandline</span><span class="p">=</span><span class="s">&quot;-object can-bus,id=canbus2 -device virtio-can-pci,canbus=canbus2,addr=07.00 -object can-host-socketcan,id=canhost2,if=vcan2,canbus=canbus2&quot;</span>
</code></pre></div>

<p>なお、Bus 0は PCI Bridgeなので避けたいと思ったのですが、同じく virtio-can-pci で使えることになっている <code>busnr</code> を使ったところ、「writableではない」という趣旨のエラーが出てしまいました。コードは未調査ですが、
最低限やりたいことはできたのでここまででヨシとすることにしました。</p>
<p>なお、qemuのdriverごとのoptionは以下で調べられるようです。
以下のvirtio-can-pciを目的のdriverに置き換えてください。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>qemu-system-aarch64<span class="w"> </span>-device<span class="w"> </span>virtio-can-pci,help
</code></pre></div>

<h2>気づき(未解決)</h2>
<p>virt-install の場合、VMを定義するとpower onまでしてくれるのですが、emulatorの変更と <code>--qemu-commandline</code> の指定を入れたところ、power onしてくれなくなりました。<code>virsh start DOMAIN_NAME(等)</code> すればよいのですが、
いったん置いてあります。</p>
<p>続くかもしれません。</p>
    </div>
  </article>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
      <li class="list-inline-item"><a href="https://thatsdone.github.io/junkbox/authors.html">Authors</a></li>
    <li class="list-inline-item"><a href="https://thatsdone.github.io/junkbox/archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="https://thatsdone.github.io/junkbox/categories.html">Categories</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
  </p>
</div>    </div>
  </footer>
</body>

</html>